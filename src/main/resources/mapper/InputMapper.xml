<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.osl.mapper.InputMapper">
	<select id="find_inputAll"
		resultType="com.osl.model.InputModel" parameterType="com.osl.model.InputModel">
		select t.* , business.name as businessName
		from t_input t 
		left join t_input_detail tdetail on t.input_id = tdetail.input_id 
		left join t_goods goods on tdetail.goods_id = goods.goods_id 
		left join t_business business on t.business_id = business.id 
		where 1=1 
        <if test="businessId !=null and businessId != ''">
        	and t.business_id= #{businessId} 
        </if>
        <if test="warehouseId !=null and warehouseId != ''">
        	and t.warehouse_id= #{warehouseId} 
        </if>
        <if test="sku !=null and sku != ''">
        	and goods.sku= #{sku} 
        </if>
        <if test="inputId !=null and inputId != ''">
        	and t.input_id= #{inputId} 
        </if>
        <if test="barcode !=null and barcode != ''">
        	and goods.barcode= #{barcode} 
        </if>
        <if test="goodsName !=null and goodsName != ''">
        	and goods.name= #{goodsName} 
        </if>
        <if test="startNewDate !=null and startNewDate != ''">
        	and tdetail.new_date <![CDATA[ >= ]]> #{startNewDate} 
        </if>
        <if test="endNewDate !=null and endNewDate != ''">
        	and tdetail.new_date <![CDATA[ <= ]]> #{endNewDate} 
        </if>
        and t.delete_flg = 0 
        order by t.update_date desc
	</select>
	
	<select id="findById" resultType="com.osl.model.InputdetailModel" parameterType="String">
		select detail.* , goods.name as goodsName , goods.sku
		from t_input_detail detail 
		left join t_goods goods on detail.goods_id = goods.goods_id
		where 1=1 
		and detail.delete_flg = 0 
		and detail.detail_id=#{detailId} 
		order by detail.update_date desc
	</select>
	
	<select id="findInputById" resultType="com.osl.model.InputModel" parameterType="String">
		select * 
		from t_input 
		where 1=1 
		and input_id = #{inputId}
	</select>
	
	<select id="findDetailListById" resultType="com.osl.model.InputdetailModel" parameterType="String">
		select tdetail.* , goods.name as goodsName , category.name as goodscategoryName , goods.sku , business.name as businessName , depot.address as depotAddress
		from t_input_detail tdetail 
		left join t_goods goods on tdetail.goods_id = goods.goods_id 
		left join t_goods_category category on goods.category_id = category.id 
		left join t_business business on business.id = (select business_id from t_input where input_id = #{inputId} )  
		left join t_depot depot on tdetail.depot_id = depot.depot_id 
		where 1=1 
		and tdetail.delete_flg = 0 
		and tdetail.input_id= #{inputId}
		order by tdetail.update_date desc
	</select>
	
	<delete id="deleteInputById" parameterType="String">
		update t_input set
		delete_flg=1 , update_date = now() where input_id= #{inputId}
	</delete>
	
	<delete id="deleteInputDetailByInputId" parameterType="String">
		update t_input_detail set
		delete_flg=1 , update_date = now() where input_id= #{inputId}
	</delete>
	
	<delete id="deleteInputDetailByDetailId" parameterType="String">
		update t_input_detail set
		delete_flg=1 , update_date = now() where detail_id= #{detailId}
	</delete>
	
	<insert id="saveNewInputDetail"
		parameterType="com.osl.model.InputdetailModel">
		insert into t_input_detail
		(detail_id, goods_id, nums, depot_id, shelves_id, inner_nums, inner_goods_nums, type, status, ship_id, goods_type, input_id, validity_time, new_date, update_date, delete_flg)
		values
		(#{detailId},#{goodsId},#{nums},#{depotId},#{shelvesId},#{innerNums},#{innerGoodsNums},#{type},#{status},#{shipId},#{goodsType},#{inputId},#{validityTime},#{newDate},#{updateDate},#{deleteFlag})
	</insert>
	
	<update id="updateInputDetail" parameterType="com.osl.model.InputdetailModel">
		update t_input_detail 
		set nums = #{nums} , depot_id = #{depotId} , shelves_id = #{shelvesId}, update_date = #{updateDate} , status = #{status} 
		where detail_id = #{detailId}
	</update>
	
	<update id="updateInput" parameterType="com.osl.model.InputModel">
		update t_input 
		set goods_nums = #{goodsNums} , update_date = #{updateDate} , status = #{status} 
		where input_id = #{inputId}
	</update>
</mapper>